<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Workflow Progress</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text: #eaeaea;
            --text-dim: #8892b0;
            --success: #64ffda;
            --warning: #ffd93d;
            --pending: #6c757d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--accent);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .sidebar h1 {
            font-size: 1.1rem;
            color: var(--highlight);
            margin: 0;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.35rem 0.5rem;
            font-size: 0.85rem;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            border-color: var(--highlight);
            color: var(--highlight);
        }

        .last-updated {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 1.5rem;
        }

        /* Progress */
        .progress-section {
            margin-bottom: 1.5rem;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .progress-bar-container {
            background: var(--accent);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #48bb78);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            color: var(--success);
        }

        /* Summary Menu */
        .summary-menu {
            margin-bottom: 1rem;
        }

        .summary-menu-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .summary-menu-item:hover {
            background: var(--accent);
            color: var(--text);
        }

        .summary-menu-item.active {
            background: var(--accent);
            color: var(--highlight);
        }

        /* Steps List */
        .steps-list {
            flex: 1;
            overflow-y: auto;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .step-item:hover { background: var(--accent); }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-item.completed .step-icon {
            background: var(--success);
            color: var(--bg-dark);
        }

        .step-item.current .step-icon {
            background: var(--warning);
            color: var(--bg-dark);
            animation: pulse 2s infinite;
        }

        .step-item.pending .step-icon {
            background: var(--pending);
            color: var(--text);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(255, 217, 61, 0); }
        }

        /* Gates (inline with steps) */
        .gate-item {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.75rem;
            background: var(--accent);
            border-radius: 4px;
            border-left: 2px solid var(--pending);
            cursor: pointer;
            transition: background 0.2s;
        }

        .gate-item:hover {
            background: #1a3a5c;
        }

        .gate-item.passed {
            border-left-color: var(--success);
        }

        .gate-icon {
            font-size: 0.8rem;
            color: var(--pending);
        }

        .gate-item.passed .gate-icon {
            color: var(--success);
        }

        .gate-name {
            color: var(--text-dim);
            flex: 1;
        }

        .gate-item.passed .gate-name {
            color: var(--success);
        }

        .gate-expand {
            font-size: 0.6rem;
            color: var(--text-dim);
            transition: transform 0.2s;
        }

        .gate-item.expanded .gate-expand {
            transform: rotate(180deg);
        }

        .gate-criteria {
            display: none;
            width: 100%;
            padding: 0.5rem 0 0 1.5rem;
            font-size: 0.7rem;
        }

        .gate-item.expanded .gate-criteria {
            display: block;
        }

        .gate-criteria-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            color: var(--text-dim);
        }

        .gate-criteria-item span:first-child {
            color: var(--pending);
        }

        /* Main Content */
        .main {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Sections */
        .section-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--accent);
        }

        .section-card h2 {
            font-size: 1rem;
            color: var(--highlight);
            margin-bottom: 1rem;
        }

        /* Decision Log */
        .decision-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--accent);
            font-size: 0.85rem;
        }

        .decision-item:last-child { border-bottom: none; }

        .decision-time {
            color: var(--text-dim);
            flex-shrink: 0;
            width: 50px;
        }

        .decision-step {
            color: var(--success);
            flex-shrink: 0;
            width: 60px;
        }

        .decision-text { color: var(--text); }

        .empty-state {
            color: var(--text-dim);
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Outputs Section */
        .outputs-section {
            display: grid;
            gap: 1.5rem;
        }

        .output-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--accent);
        }

        .output-card h3 {
            font-size: 0.95rem;
            color: var(--highlight);
            margin-bottom: 1rem;
        }

        .output-diagram {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
        }

        .output-diagram.mermaid {
            display: flex;
            justify-content: center;
        }

        .output-link {
            color: var(--success);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .output-link:hover { text-decoration: underline; }

        /* Prototype Section */
        .prototype-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--accent);
        }

        .prototype-menu-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .prototype-menu-item:hover {
            background: var(--accent);
            color: var(--success);
        }
    </style>
</head>
<body>
    <!-- Embedded Workflow State (Sub-Agent Updates This) -->
    <script id="workflow-state" type="application/json">
{
    "lastUpdated": "",
    "summary": "",
    "enabledSteps": [],
    "completedSteps": [],
    "currentStep": 1,
    "gates": { "1": "pending", "2": "pending", "3": "pending", "4a": "pending", "4b": "pending" },
    "decisions": [],
    "outputs": []
}
    </script>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>Design Workflow</h1>
            <button class="refresh-btn" onclick="loadState()" title="Refresh">&#x21bb;</button>
        </div>
        <div class="last-updated" id="lastUpdated">Last updated: --</div>

        <div class="progress-section">
            <div class="progress-label">PROGRESS</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0/9 steps</div>
        </div>

        <div class="summary-menu">
            <div class="summary-menu-item" onclick="scrollToSection('summarySection')">
                <span>SUMMARY</span>
            </div>
        </div>

        <div class="steps-list" id="stepsList">
            <!-- Steps and gates rendered by JS -->
        </div>

        <!-- PROTOTYPE Section -->
        <div class="prototype-section">
            <div class="progress-label" style="margin-top: 1rem;">PROTOTYPE</div>
            <div class="prototype-menu">
                <!-- To add prototypes, prompt: "add prototype: [filename] [label]" -->
            </div>
        </div>
    </aside>

    <main class="main">
        <section class="section-card" id="summarySection">
            <h2>Summary</h2>
            <div id="summaryContent">
                <div class="empty-state">No summary yet. Complete workflow steps to generate a summary.</div>
            </div>
        </section>

        <section class="section-card">
            <h2>Decision Log</h2>
            <div id="decisionsList">
                <div class="empty-state">No decisions recorded yet. Complete workflow steps to see decisions here.</div>
            </div>
        </section>

        <section class="outputs-section" id="outputsList">
            <!-- Outputs rendered by JS -->
        </section>
    </main>

    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'default' });

        const ALL_STEPS = {
            1: 'Reframe Problem',
            2: 'List Assumptions',
            3: 'Form Hypothesis',
            4: 'Benchmarking Criteria',
            5: 'Solution Approaches',
            6: 'Solution Tradeoffs',
            7: 'OOUX & User Flows',
            8: 'Scope & Metrics',
            9: 'UX Interactions'
        };

        const GATES = [
            {
                num: '1',
                name: 'Impact Matrix',
                afterStep: 3,
                mandatory: false,
                criteria: [
                    'Impact vs effort evaluated',
                    'Accept/Defer/Reject decision'
                ]
            },
            {
                num: '4a',
                name: 'Ethics Framing',
                afterStep: 3,
                mandatory: false,
                criteria: [
                    'Hypothesis ethics checked',
                    'Direction risks identified',
                    'Forgotten users listed'
                ]
            },
            {
                num: '2',
                name: 'Dependency Analysis',
                afterStep: 5,
                mandatory: false,
                criteria: [
                    'Affected flows mapped',
                    'Component dependencies identified',
                    'Ripple effects analyzed'
                ]
            },
            {
                num: '3',
                name: 'Pre-Build Review',
                afterStep: 8,
                mandatory: true,
                criteria: [
                    'Scope boundaries clear',
                    'Success metrics defined',
                    'Risks mitigated',
                    'Ready for development'
                ]
            },
            {
                num: '4b',
                name: 'Ethics & Inclusive UX',
                afterStep: 9,
                mandatory: false,
                criteria: [
                    'Cognitive load reviewed',
                    'Dark patterns checked',
                    'Inclusion verified',
                    'Wellbeing considered'
                ]
            }
        ];

        function loadState() {
            const stateEl = document.getElementById('workflow-state');
            const state = JSON.parse(stateEl.textContent);
            renderDashboard(state);
        }

        function renderDashboard(state) {
            // Get enabled steps (fallback to all if not set)
            const enabledSteps = (state.enabledSteps && state.enabledSteps.length > 0)
                ? state.enabledSteps
                : Object.keys(ALL_STEPS).map(Number);

            // Update last updated
            const lastUpdated = state.lastUpdated || new Date().toISOString().replace('T', ' ').slice(0, 19);
            document.getElementById('lastUpdated').textContent = `Last updated: ${lastUpdated}`;

            // Update progress (based on enabled steps only)
            const completed = state.completedSteps.filter(s => enabledSteps.includes(s)).length;
            const total = enabledSteps.length;
            const percent = Math.round((completed / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${completed}/${total} steps (${percent}%)`;

            // Render summary
            const summaryEl = document.getElementById('summaryContent');
            if (state.summary && state.summary.trim()) {
                summaryEl.innerHTML = state.summary;
            } else {
                summaryEl.innerHTML = '<div class="empty-state">No summary yet. Complete workflow steps to generate a summary.</div>';
            }

            // Render steps with gates inline (only enabled steps)
            const stepsList = document.getElementById('stepsList');
            let html = '';

            enabledSteps.forEach(stepNum => {
                const stepName = ALL_STEPS[stepNum];
                let status = 'pending';
                if (state.completedSteps.includes(stepNum)) status = 'completed';
                else if (stepNum === state.currentStep) status = 'current';

                const icon = status === 'completed' ? '✓' : stepNum;
                html += `
                    <div class="step-item ${status}" data-step="${stepNum}">
                        <div class="step-icon">${icon}</div>
                        <div class="step-name">${stepName}</div>
                    </div>
                `;

                // Add gate after its trigger step
                const gate = GATES.find(g => g.afterStep === stepNum);

                if (gate) {
                    const gateStatus = state.gates[gate.num] || 'pending';
                    const gateIcon = gateStatus === 'passed' ? '✓' : '○';
                    const mandatoryLabel = gate.mandatory ? ' ⭐' : '';
                    const criteriaHtml = gate.criteria.map(c => `
                        <div class="gate-criteria-item">
                            <span>○</span>
                            <span>${c}</span>
                        </div>
                    `).join('');
                    html += `
                        <div class="gate-item ${gateStatus}" onclick="toggleGate(this)">
                            <span class="gate-icon">${gateIcon}</span>
                            <span class="gate-name">Gate ${gate.num}: ${gate.name}${mandatoryLabel}</span>
                            <span class="gate-expand">▼</span>
                            <div class="gate-criteria">${criteriaHtml}</div>
                        </div>
                    `;
                }
            });

            stepsList.innerHTML = html;

            // Render decisions
            const decisionsList = document.getElementById('decisionsList');
            if (state.decisions.length === 0) {
                decisionsList.innerHTML = '<div class="empty-state">No decisions recorded yet. Complete workflow steps to see decisions here.</div>';
            } else {
                decisionsList.innerHTML = state.decisions.map(d => `
                    <div class="decision-item">
                        <span class="decision-time">${d.time}</span>
                        <span class="decision-step">Step ${d.step}</span>
                        <span class="decision-text">${d.text}</span>
                    </div>
                `).join('');
            }

            // Render outputs
            const outputsList = document.getElementById('outputsList');
            if (state.outputs.length === 0) {
                outputsList.innerHTML = '<div class="output-card"><div class="empty-state">No outputs yet. Complete workflow steps to see visualizations here.</div></div>';
            } else {
                outputsList.innerHTML = state.outputs.map((output, idx) => {
                    let content = '';
                    if (output.diagramType === 'mermaid') {
                        content = `<div class="output-diagram mermaid" id="mermaid-${idx}">${output.diagram}</div>`;
                    } else if (output.diagramType === 'html') {
                        content = `<a href="${output.diagram}" target="_blank" class="output-link">Open visualization: ${output.diagram}</a>`;
                    } else {
                        content = '<div class="empty-state">No visualization for this step.</div>';
                    }
                    return `
                        <div class="output-card" id="output-step-${output.step}">
                            <h3>${output.title}</h3>
                            ${content}
                        </div>
                    `;
                }).join('');

                // Render mermaid diagrams
                setTimeout(() => {
                    state.outputs.forEach((output, idx) => {
                        if (output.diagramType === 'mermaid') {
                            const el = document.getElementById(`mermaid-${idx}`);
                            if (el) {
                                mermaid.render(`mermaid-svg-${idx}`, output.diagram).then(result => {
                                    el.innerHTML = result.svg;
                                }).catch(err => {
                                    el.innerHTML = `<pre style="color: red;">Mermaid error: ${err.message}</pre>`;
                                });
                            }
                        }
                    });
                }, 100);
            }
        }

        // Scroll to section
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Toggle gate criteria visibility
        function toggleGate(el) {
            el.classList.toggle('expanded');
        }

        // Load state on page load
        document.addEventListener('DOMContentLoaded', loadState);
    </script>
</body>
</html>
